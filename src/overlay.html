<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timer</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../lib/obs-overlay.css" rel="stylesheet">
</head>
<body>

    <widget-overlay>
        <div data-id="time">00:00:00</div>
    </widget-overlay>

    <timer-dock>
        <div class="timer" id="timer" style="margin: 0 0 10px 0;">
            <input id="hours" value="00" max="99" step="1">
            :
            <input id="minutes" value="00" max="99" step="1">
            :
            <input id="seconds" value="00" max="99" step="1">
        </div>
    
        <div class="controls">
            <button data-onclick="reset" class="material-icons">restore</button>
            <button data-onclick="togglePlay" class="material-icons">play_arrow</button>
            <button data-onclick="toggleCountdown" class="material-icons">timer</button>
        </div>
    </timer-dock>
    
    <script type="module">
        import { Overlay, Dock } from '../lib/obs-overlay.js';

        resetButton.addEventListener('click', () => reset());
        playButton.addEventListener('click', () => togglePlay());
        countdownButton.addEventListener('click', () => toggleCountdown());
        timer.addEventListener('input', () => setTimer());

        let state = {
            playing: false,
            countdown: false,
            time: 0,
        };

        let lastTick = Date.now();

        function tick() {
            const currentTick = Date.now();
            const delta = currentTick - lastTick;

            if(state.playing) {
                if(state.countdown) {
                    if(state.time - delta >= 0) {
                        state.time -= delta;
                    } else {
                        state.time = 0;
                        pause();
                    }
                } else {
                    state.time += delta;
                }

                update();
            }

            lastTick = currentTick;
        }

        setInterval(() => tick(), 100);

        class TimerDock extends Dock {

            update() {
                let s = Math.floor(state.time / 1000) % 60;
                let m = Math.floor(state.time / 1000 / 60) % 60;
                let h = Math.floor(state.time / 1000 / 60 / 60) % 60;

                hours.value = h.toString().padStart(2, '0');
                minutes.value = m.toString().padStart(2, '0');
                seconds.value = s.toString().padStart(2, '0');

                localStorage.setItem('timer', `${hours.value}:${minutes.value}:${seconds.value}`);
            }

            setTimer() {
                state.time = (seconds.value * 1000) + (minutes.value * 60 * 1000) + (hours.value * 60 * 60 * 1000);
                updateDisplay();
            }

            reset() {
                state.time = 0;
                
                pause();
                updateDisplay();
            }

            pause() {
                state.playing = false;
                playButton.innerText = "play_arrow";
            }

            play() {
                state.playing = true;
                playButton.innerText = "pause";
            }

            togglePlay() {
                if(state.playing) {
                    pause();
                } else {
                    play();
                }
            }

            toggleCountdown() {
                state.countdown = !state.countdown;
                
                if(state.countdown) {
                    countdownButton.setAttribute('active', '');
                } else {
                    countdownButton.removeAttribute('active');
                }
            }

        }

        customElements.define('timer-dock', TimerDock);
    </script>
</body>
</html>